import logging
import requests
import json
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
import asyncio
from datetime import datetime

# Bot token
BOT_TOKEN = "7968532349:AAFGFSe_aFShl7NMa9S1R_tjkC9IyoUGMTI"

# Configure logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Currency codes mapping
CURRENCY_CODES = {
    'TRY': 'Turkish Lira',
    'AZN': 'Azerbaijani Manat', 
    'RUB': 'Russian Ruble',
    'USD': 'US Dollar',
    'EUR': 'Euro',
    'GBP': 'British Pound',
    'BTC': 'Bitcoin',
    'ETH': 'Ethereum',
    'BNB': 'Binance Coin',
    'ADA': 'Cardano',
    'SOL': 'Solana',
    'XRP': 'Ripple',
    'DOT': 'Polkadot',
    'DOGE': 'Dogecoin',
    'MATIC': 'Polygon',
    'AVAX': 'Avalanche',
    'LINK': 'Chainlink',
    'UNI': 'Uniswap',
    'LTC': 'Litecoin',
    'ATOM': 'Cosmos',
    'FTM': 'Fantom',
    'ALGO': 'Algorand',
    'VET': 'VeChain',
    'FIL': 'Filecoin',
    'TRX': 'TRON',
    'XLM': 'Stellar',
    'MANA': 'Decentraland',
    'SAND': 'The Sandbox',
    'AXS': 'Axie Infinity',
    'CHZ': 'Chiliz',
    'ENJ': 'Enjin Coin',
    'BAT': 'Basic Attention Token',
    'ZEC': 'Zcash',
    'DASH': 'Dash',
    'NEO': 'NEO',
    'QTUM': 'Qtum',
    'ICX': 'ICON',
    'ONT': 'Ontology',
    'ZIL': 'Zilliqa',
    'WAVES': 'Waves',
    'KSM': 'Kusama',
    'GRT': 'The Graph',
    'COMP': 'Compound',
    'YFI': 'Yearn.finance',
    'SNX': 'Synthetix',
    'MKR': 'Maker',
    'AAVE': 'Aave',
    'CRV': 'Curve DAO Token',
    '1INCH': '1inch',
    'SUSHI': 'SushiSwap',
    'CAKE': 'PancakeSwap',
    'SHIB': 'Shiba Inu',
    'PEPE': 'Pepe',
    'FLOKI': 'Floki',
    'BONK': 'Bonk'
}

# Language support
LANGUAGES = {
    'tr': {
        'welcome': 'Ho≈ü geldiniz! Para birimi botuna ho≈ü geldiniz.',
        'main_menu': 'Ana Men√º',
        'current_rates': 'G√ºncel Kurlar',
        'currency_comparison': 'Para Birimi Kar≈üƒ±la≈ütƒ±rmasƒ±',
        'crypto_rates': 'Kripto Para Kurlarƒ±',
        'language_select': 'Dil Se√ßin',
        'enter_amount': 'Kar≈üƒ±la≈ütƒ±rma i√ßin miktar girin:',
        'select_currency': 'Para birimi se√ßin:',
        'from_currency': 'Hangi para biriminden:',
        'to_currency': 'Hangi para birimine:',
        'error': 'Hata olu≈ütu. L√ºtfen tekrar deneyin.',
        'invalid_amount': 'Ge√ßersiz miktar. L√ºtfen sayƒ± girin.',
        'rate_not_found': 'Kur bulunamadƒ±.',
        'back': 'Geri',
        'result': 'Sonu√ß:',
        'quick_tip': 'ƒ∞pucu: Direkt olarak \'20 USD AZN\' ≈üeklinde yazabilirsiniz!'
    },
    'en': {
        'welcome': 'Welcome! Welcome to the currency bot.',
        'main_menu': 'Main Menu',
        'current_rates': 'Current Rates',
        'currency_comparison': 'Currency Comparison',
        'crypto_rates': 'Cryptocurrency Rates',
        'language_select': 'Select Language',
        'enter_amount': 'Enter amount for comparison:',
        'select_currency': 'Select currency:',
        'from_currency': 'From currency:',
        'to_currency': 'To currency:',
        'error': 'An error occurred. Please try again.',
        'invalid_amount': 'Invalid amount. Please enter a number.',
        'rate_not_found': 'Exchange rate not found.',
        'back': 'Back',
        'result': 'Result:',
        'quick_tip': 'Tip: You can type directly like \'20 USD AZN\'!'
    },
    'ru': {
        'welcome': '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –≤–∞–ª—é—Ç–Ω—ã–π –±–æ—Ç.',
        'main_menu': '–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é',
        'current_rates': '–¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã',
        'currency_comparison': '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞–ª—é—Ç',
        'crypto_rates': '–ö—É—Ä—Å—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç',
        'language_select': '–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫',
        'enter_amount': '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:',
        'select_currency': '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞–ª—é—Ç—É:',
        'from_currency': '–ò–∑ –≤–∞–ª—é—Ç—ã:',
        'to_currency': '–í –≤–∞–ª—é—Ç—É:',
        'error': '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.',
        'invalid_amount': '–ù–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.',
        'rate_not_found': '–ö—É—Ä—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.',
        'back': '–ù–∞–∑–∞–¥',
        'result': '–†–µ–∑—É–ª—å—Ç–∞—Ç:',
        'quick_tip': '–°–æ–≤–µ—Ç: –ú–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∫–∞–∫ \'20 USD AZN\'!'
    }
}

# User language preferences
user_languages = {}

def get_user_language(user_id):
    return user_languages.get(user_id, 'tr')

def get_text(user_id, key):
    lang = get_user_language(user_id)
    return LANGUAGES[lang].get(key, LANGUAGES['tr'][key])

async def get_exchange_rates():
    """Get current exchange rates from API"""
    try:
        # Using exchangerate-api.com for free rates
        response = requests.get('https://api.exchangerate-api.com/v4/latest/USD')
        if response.status_code == 200:
            return response.json()['rates']
        else:
            # Fallback to fixer.io if available
            response = requests.get('https://api.fixer.io/latest?base=USD')
            if response.status_code == 200:
                return response.json()['rates']
    except Exception as e:
        logger.error(f"Error fetching exchange rates: {e}")
    return None

async def get_crypto_rates():
    """Get current cryptocurrency rates"""
    try:
        # Extended list of cryptocurrencies
        crypto_ids = [
            'bitcoin', 'ethereum', 'binancecoin', 'cardano', 'solana',
            'ripple', 'polkadot', 'dogecoin', 'polygon', 'avalanche-2',
            'chainlink', 'uniswap', 'litecoin', 'cosmos', 'fantom',
            'algorand', 'vechain', 'filecoin', 'tron', 'stellar',
            'decentraland', 'the-sandbox', 'axie-infinity', 'chiliz',
            'enjincoin', 'basic-attention-token', 'zcash', 'dash',
            'neo', 'qtum', 'icon', 'ontology', 'zilliqa', 'waves',
            'kusama', 'the-graph', 'compound-governance-token',
            'yearn-finance', 'havven', 'maker', 'aave', 'curve-dao-token',
            '1inch', 'sushiswap', 'pancakeswap-token', 'shiba-inu',
            'pepe', 'floki', 'bonk'
        ]
        
        ids_string = ','.join(crypto_ids)
        response = requests.get(f'https://api.coingecko.com/api/v3/simple/price?ids={ids_string}&vs_currencies=usd')
        
        if response.status_code == 200:
            data = response.json()
            crypto_rates = {}
            crypto_mapping = {
                'bitcoin': 'BTC', 'ethereum': 'ETH', 'binancecoin': 'BNB',
                'cardano': 'ADA', 'solana': 'SOL', 'ripple': 'XRP',
                'polkadot': 'DOT', 'dogecoin': 'DOGE', 'polygon': 'MATIC',
                'avalanche-2': 'AVAX', 'chainlink': 'LINK', 'uniswap': 'UNI',
                'litecoin': 'LTC', 'cosmos': 'ATOM', 'fantom': 'FTM',
                'algorand': 'ALGO', 'vechain': 'VET', 'filecoin': 'FIL',
                'tron': 'TRX', 'stellar': 'XLM', 'decentraland': 'MANA',
                'the-sandbox': 'SAND', 'axie-infinity': 'AXS', 'chiliz': 'CHZ',
                'enjincoin': 'ENJ', 'basic-attention-token': 'BAT',
                'zcash': 'ZEC', 'dash': 'DASH', 'neo': 'NEO', 'qtum': 'QTUM',
                'icon': 'ICX', 'ontology': 'ONT', 'zilliqa': 'ZIL',
                'waves': 'WAVES', 'kusama': 'KSM', 'the-graph': 'GRT',
                'compound-governance-token': 'COMP', 'yearn-finance': 'YFI',
                'havven': 'SNX', 'maker': 'MKR', 'aave': 'AAVE',
                'curve-dao-token': 'CRV', '1inch': '1INCH', 'sushiswap': 'SUSHI',
                'pancakeswap-token': 'CAKE', 'shiba-inu': 'SHIB',
                'pepe': 'PEPE', 'floki': 'FLOKI', 'bonk': 'BONK'
            }
            
            for coin_id, symbol in crypto_mapping.items():
                if coin_id in data:
                    crypto_rates[symbol] = data[coin_id]['usd']
            return crypto_rates
    except Exception as e:
        logger.error(f"Error fetching crypto rates: {e}")
    return None

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Start command handler"""
    user_id = update.effective_user.id
    
    # Only set default language if user hasn't selected one before
    if user_id not in user_languages:
        user_languages[user_id] = 'tr'  # Default to Turkish
    
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'current_rates'), callback_data='current_rates')],
        [InlineKeyboardButton(get_text(user_id, 'currency_comparison'), callback_data='currency_comparison')],
        [InlineKeyboardButton(get_text(user_id, 'crypto_rates'), callback_data='crypto_rates')],
        [InlineKeyboardButton(get_text(user_id, 'language_select'), callback_data='language_select')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # Get user's language
    lang = get_user_language(user_id)
    
    welcome_text = f"{get_text(user_id, 'welcome')}\n\n"
    
    if lang == 'tr':
        welcome_text += "üí° **Hƒ±zlƒ± Kullanƒ±m:**\n"
        welcome_text += "‚Ä¢ `20 USD AZN` - 20 dolar ka√ß manat?\n"
        welcome_text += "‚Ä¢ `100 BTC TRY` - 100 bitcoin ka√ß lira?\n"
        welcome_text += "‚Ä¢ `50 ETH EUR` - 50 ethereum ka√ß euro?\n"
        welcome_text += "‚Ä¢ `1000 TRY USD` - 1000 lira ka√ß dolar?\n\n"
        welcome_text += "Direkt mesaj olarak yazabilirsiniz!"
    elif lang == 'en':
        welcome_text += "üí° **Quick Usage:**\n"
        welcome_text += "‚Ä¢ `20 USD AZN` - How much is 20 dollars in manat?\n"
        welcome_text += "‚Ä¢ `100 BTC TRY` - How much is 100 bitcoin in lira?\n"
        welcome_text += "‚Ä¢ `50 ETH EUR` - How much is 50 ethereum in euro?\n"
        welcome_text += "‚Ä¢ `1000 TRY USD` - How much is 1000 lira in dollars?\n\n"
        welcome_text += "You can type directly as a message!"
    elif lang == 'ru':
        welcome_text += "üí° **–ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**\n"
        welcome_text += "‚Ä¢ `20 USD AZN` - –°–∫–æ–ª—å–∫–æ –º–∞–Ω–∞—Ç –≤ 20 –¥–æ–ª–ª–∞—Ä–∞—Ö?\n"
        welcome_text += "‚Ä¢ `100 BTC TRY` - –°–∫–æ–ª—å–∫–æ –ª–∏—Ä –≤ 100 –±–∏—Ç–∫–æ–∏–Ω–∞—Ö?\n"
        welcome_text += "‚Ä¢ `50 ETH EUR` - –°–∫–æ–ª—å–∫–æ –µ–≤—Ä–æ –≤ 50 —ç—Ñ–∏—Ä–∏—É–º–∞—Ö?\n"
        welcome_text += "‚Ä¢ `1000 TRY USD` - –°–∫–æ–ª—å–∫–æ –¥–æ–ª–ª–∞—Ä–æ–≤ –≤ 1000 –ª–∏—Ä–∞—Ö?\n\n"
        welcome_text += "–ú–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ!"
    
    await update.message.reply_text(
        welcome_text,
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Help command handler"""
    user_id = update.effective_user.id
    lang = get_user_language(user_id)
    
    if lang == 'tr':
        help_text = "ü§ñ **Para Birimi Botu Yardƒ±m**\n\n"
        help_text += "**Hƒ±zlƒ± D√∂n√º≈ü√ºm:**\n"
        help_text += "‚Ä¢ `20 USD AZN` - 20 dolar ka√ß manat?\n"
        help_text += "‚Ä¢ `100 BTC TRY` - 100 bitcoin ka√ß lira?\n"
        help_text += "‚Ä¢ `50 ETH EUR` - 50 ethereum ka√ß euro?\n"
        help_text += "‚Ä¢ `1000 TRY USD` - 1000 lira ka√ß dolar?\n\n"
        help_text += "**Desteklenen Para Birimleri:**\n"
        help_text += "üáπüá∑ TRY üá¶üáø AZN üá∑üá∫ RUB üá∫üá∏ USD üá™üá∫ EUR üá¨üáß GBP\n"
        help_text += "‚Çø BTC Œû ETH üü° BNB üîµ ADA üü£ SOL üíß XRP\n"
        help_text += "üî¥ DOT üêï DOGE üü£ MATIC üî∫ AVAX\n\n"
        help_text += "**Komutlar:**\n"
        help_text += "‚Ä¢ `/start` - Ana men√º\n"
        help_text += "‚Ä¢ `/help` - Bu yardƒ±m mesajƒ±\n\n"
        help_text += "**√ñzellikler:**\n"
        help_text += "‚Ä¢ G√ºncel d√∂viz kurlarƒ±\n"
        help_text += "‚Ä¢ Kripto para fiyatlarƒ±\n"
        help_text += "‚Ä¢ Para birimi d√∂n√º≈ü√ºm√º\n"
        help_text += "‚Ä¢ 3 dil desteƒüi (TR/EN/RU)"
    elif lang == 'en':
        help_text = "ü§ñ **Currency Bot Help**\n\n"
        help_text += "**Quick Conversion:**\n"
        help_text += "‚Ä¢ `20 USD AZN` - How much is 20 dollars in manat?\n"
        help_text += "‚Ä¢ `100 BTC TRY` - How much is 100 bitcoin in lira?\n"
        help_text += "‚Ä¢ `50 ETH EUR` - How much is 50 ethereum in euro?\n"
        help_text += "‚Ä¢ `1000 TRY USD` - How much is 1000 lira in dollars?\n\n"
        help_text += "**Supported Currencies:**\n"
        help_text += "üáπüá∑ TRY üá¶üáø AZN üá∑üá∫ RUB üá∫üá∏ USD üá™üá∫ EUR üá¨üáß GBP\n"
        help_text += "‚Çø BTC Œû ETH üü° BNB üîµ ADA üü£ SOL üíß XRP\n"
        help_text += "üî¥ DOT üêï DOGE üü£ MATIC üî∫ AVAX\n\n"
        help_text += "**Commands:**\n"
        help_text += "‚Ä¢ `/start` - Main menu\n"
        help_text += "‚Ä¢ `/help` - This help message\n\n"
        help_text += "**Features:**\n"
        help_text += "‚Ä¢ Current exchange rates\n"
        help_text += "‚Ä¢ Cryptocurrency prices\n"
        help_text += "‚Ä¢ Currency conversion\n"
        help_text += "‚Ä¢ 3 language support (TR/EN/RU)"
    elif lang == 'ru':
        help_text = "ü§ñ **–ü–æ–º–æ—â—å –≤–∞–ª—é—Ç–Ω–æ–≥–æ –±–æ—Ç–∞**\n\n"
        help_text += "**–ë—ã—Å—Ç—Ä–æ–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**\n"
        help_text += "‚Ä¢ `20 USD AZN` - –°–∫–æ–ª—å–∫–æ –º–∞–Ω–∞—Ç –≤ 20 –¥–æ–ª–ª–∞—Ä–∞—Ö?\n"
        help_text += "‚Ä¢ `100 BTC TRY` - –°–∫–æ–ª—å–∫–æ –ª–∏—Ä –≤ 100 –±–∏—Ç–∫–æ–∏–Ω–∞—Ö?\n"
        help_text += "‚Ä¢ `50 ETH EUR` - –°–∫–æ–ª—å–∫–æ –µ–≤—Ä–æ –≤ 50 —ç—Ñ–∏—Ä–∏—É–º–∞—Ö?\n"
        help_text += "‚Ä¢ `1000 TRY USD` - –°–∫–æ–ª—å–∫–æ –¥–æ–ª–ª–∞—Ä–æ–≤ –≤ 1000 –ª–∏—Ä–∞—Ö?\n\n"
        help_text += "**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–∞–ª—é—Ç—ã:**\n"
        help_text += "üáπüá∑ TRY üá¶üáø AZN üá∑üá∫ RUB üá∫üá∏ USD üá™üá∫ EUR üá¨üáß GBP\n"
        help_text += "‚Çø BTC Œû ETH üü° BNB üîµ ADA üü£ SOL üíß XRP\n"
        help_text += "üî¥ DOT üêï DOGE üü£ MATIC üî∫ AVAX\n\n"
        help_text += "**–ö–æ–º–∞–Ω–¥—ã:**\n"
        help_text += "‚Ä¢ `/start` - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        help_text += "‚Ä¢ `/help` - –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–æ—â–∏\n\n"
        help_text += "**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**\n"
        help_text += "‚Ä¢ –¢–µ–∫—É—â–∏–µ –∫—É—Ä—Å—ã –≤–∞–ª—é—Ç\n"
        help_text += "‚Ä¢ –¶–µ–Ω—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç\n"
        help_text += "‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤–∞–ª—é—Ç\n"
        help_text += "‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 3 —è–∑—ã–∫–æ–≤ (TR/EN/RU)"
    
    await update.message.reply_text(help_text, parse_mode='Markdown')

async def button_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle button callbacks"""
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    
    if query.data == 'current_rates':
        await show_current_rates(query, context)
    elif query.data == 'currency_comparison':
        await show_currency_comparison_menu(query, context)
    elif query.data == 'crypto_rates':
        await show_crypto_rates(query, context)
    elif query.data == 'language_select':
        await show_language_menu(query, context)
    elif query.data.startswith('lang_'):
        lang = query.data.split('_')[1]
        user_languages[user_id] = lang
        await show_main_menu(query, context)
    elif query.data.startswith('from_'):
        currency = query.data.split('_')[1]
        context.user_data['from_currency'] = currency
        await show_to_currency_menu(query, context)
    elif query.data.startswith('to_'):
        currency = query.data.split('_')[1]
        context.user_data['to_currency'] = currency
        await ask_amount(query, context)
    elif query.data == 'back_to_main':
        await show_main_menu(query, context)

async def show_current_rates(query, context):
    """Show current exchange rates"""
    user_id = query.from_user.id
    rates = await get_exchange_rates()
    
    if not rates:
        await query.edit_message_text(get_text(user_id, 'error'))
        return
    
    text = f"üìä {get_text(user_id, 'current_rates')}\n\n"
    text += f"üáπüá∑ TRY: 1 USD = {rates.get('TRY', 'N/A'):.2f} TRY\n"
    text += f"üá¶üáø AZN: 1 USD = {rates.get('AZN', 'N/A'):.2f} AZN\n"
    text += f"üá∑üá∫ RUB: 1 USD = {rates.get('RUB', 'N/A'):.2f} RUB\n"
    text += f"üá∫üá∏ USD: 1 USD = 1.00 USD\n"
    text += f"üá™üá∫ EUR: 1 USD = {rates.get('EUR', 'N/A'):.2f} EUR\n"
    text += f"üá¨üáß GBP: 1 USD = {rates.get('GBP', 'N/A'):.2f} GBP\n"
    
    keyboard = [[InlineKeyboardButton(get_text(user_id, 'back'), callback_data='back_to_main')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(text, reply_markup=reply_markup)

async def show_crypto_rates(query, context):
    """Show cryptocurrency rates"""
    user_id = query.from_user.id
    crypto_rates = await get_crypto_rates()
    
    if not crypto_rates:
        await query.edit_message_text(get_text(user_id, 'error'))
        return
    
    text = f"‚Çø {get_text(user_id, 'crypto_rates')}\n\n"
    
    # Top cryptocurrencies
    top_crypto = ['BTC', 'ETH', 'BNB', 'ADA', 'SOL', 'XRP', 'DOT', 'DOGE', 'MATIC', 'AVAX']
    crypto_emojis = {
        'BTC': '‚Çø', 'ETH': 'Œû', 'BNB': 'üü°', 'ADA': 'üîµ', 'SOL': 'üü£',
        'XRP': 'üíß', 'DOT': 'üî¥', 'DOGE': 'üêï', 'MATIC': 'üü£', 'AVAX': 'üî∫'
    }
    
    for symbol in top_crypto:
        if symbol in crypto_rates:
            emoji = crypto_emojis.get(symbol, 'üí∞')
            price = crypto_rates[symbol]
            if price >= 1:
                text += f"{emoji} {symbol}: ${price:,.2f}\n"
            else:
                text += f"{emoji} {symbol}: ${price:.6f}\n"
    
    text += "\nüìà Diƒüer Pop√ºler Kripto Paralar:\n"
    
    # Other popular cryptocurrencies
    other_crypto = ['LINK', 'UNI', 'LTC', 'ATOM', 'FTM', 'ALGO', 'VET', 'FIL', 'TRX', 'XLM']
    for symbol in other_crypto:
        if symbol in crypto_rates:
            price = crypto_rates[symbol]
            if price >= 1:
                text += f"‚Ä¢ {symbol}: ${price:,.2f}\n"
            else:
                text += f"‚Ä¢ {symbol}: ${price:.6f}\n"
    
    keyboard = [[InlineKeyboardButton(get_text(user_id, 'back'), callback_data='back_to_main')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(text, reply_markup=reply_markup)

async def show_currency_comparison_menu(query, context):
    """Show currency comparison menu"""
    user_id = query.from_user.id
    
    keyboard = [
        [InlineKeyboardButton("üáπüá∑ TRY", callback_data='from_TRY'),
         InlineKeyboardButton("üá¶üáø AZN", callback_data='from_AZN'),
         InlineKeyboardButton("üá∑üá∫ RUB", callback_data='from_RUB')],
        [InlineKeyboardButton("üá∫üá∏ USD", callback_data='from_USD'),
         InlineKeyboardButton("üá™üá∫ EUR", callback_data='from_EUR'),
         InlineKeyboardButton("üá¨üáß GBP", callback_data='from_GBP')],
        [InlineKeyboardButton("‚Çø BTC", callback_data='from_BTC'),
         InlineKeyboardButton("Œû ETH", callback_data='from_ETH'),
         InlineKeyboardButton("üü° BNB", callback_data='from_BNB')],
        [InlineKeyboardButton("üîµ ADA", callback_data='from_ADA'),
         InlineKeyboardButton("üü£ SOL", callback_data='from_SOL'),
         InlineKeyboardButton("üíß XRP", callback_data='from_XRP')],
        [InlineKeyboardButton("üî¥ DOT", callback_data='from_DOT'),
         InlineKeyboardButton("üêï DOGE", callback_data='from_DOGE'),
         InlineKeyboardButton("üü£ MATIC", callback_data='from_MATIC')],
        [InlineKeyboardButton("üî∫ AVAX", callback_data='from_AVAX'),
         InlineKeyboardButton("üîó LINK", callback_data='from_LINK'),
         InlineKeyboardButton("ü¶Ñ UNI", callback_data='from_UNI')],
        [InlineKeyboardButton("‚ö° LTC", callback_data='from_LTC'),
         InlineKeyboardButton("üåå ATOM", callback_data='from_ATOM'),
         InlineKeyboardButton("üëª FTM", callback_data='from_FTM')],
        [InlineKeyboardButton("üîµ ALGO", callback_data='from_ALGO'),
         InlineKeyboardButton("üì∫ VET", callback_data='from_VET'),
         InlineKeyboardButton("üìÅ FIL", callback_data='from_FIL')],
        [InlineKeyboardButton("üåê TRX", callback_data='from_TRX'),
         InlineKeyboardButton("‚≠ê XLM", callback_data='from_XLM'),
         InlineKeyboardButton("üéÆ MANA", callback_data='from_MANA')],
        [InlineKeyboardButton("üèñÔ∏è SAND", callback_data='from_SAND'),
         InlineKeyboardButton("üéØ AXS", callback_data='from_AXS'),
         InlineKeyboardButton("‚öΩ CHZ", callback_data='from_CHZ')],
        [InlineKeyboardButton("üíé ENJ", callback_data='from_ENJ'),
         InlineKeyboardButton("ü¶á BAT", callback_data='from_BAT'),
         InlineKeyboardButton("üîí ZEC", callback_data='from_ZEC')],
        [InlineKeyboardButton("üí® DASH", callback_data='from_DASH'),
         InlineKeyboardButton("üîµ NEO", callback_data='from_NEO'),
         InlineKeyboardButton("üî∑ QTUM", callback_data='from_QTUM')],
        [InlineKeyboardButton("üü† ICX", callback_data='from_ICX'),
         InlineKeyboardButton("üî∑ ONT", callback_data='from_ONT'),
         InlineKeyboardButton("‚ö° ZIL", callback_data='from_ZIL')],
        [InlineKeyboardButton("üåä WAVES", callback_data='from_WAVES'),
         InlineKeyboardButton("üü£ KSM", callback_data='from_KSM'),
         InlineKeyboardButton("üìä GRT", callback_data='from_GRT')],
        [InlineKeyboardButton("üèõÔ∏è COMP", callback_data='from_COMP'),
         InlineKeyboardButton("üí∞ YFI", callback_data='from_YFI'),
         InlineKeyboardButton("üîó SNX", callback_data='from_SNX')],
        [InlineKeyboardButton("üè≠ MKR", callback_data='from_MKR'),
         InlineKeyboardButton("üè¶ AAVE", callback_data='from_AAVE'),
         InlineKeyboardButton("üîÑ CRV", callback_data='from_CRV')],
        [InlineKeyboardButton("1Ô∏è‚É£ 1INCH", callback_data='from_1INCH'),
         InlineKeyboardButton("üç£ SUSHI", callback_data='from_SUSHI'),
         InlineKeyboardButton("ü•û CAKE", callback_data='from_CAKE')],
        [InlineKeyboardButton("üêï SHIB", callback_data='from_SHIb'),
         InlineKeyboardButton("üê∏ PEPE", callback_data='from_PEPE'),
         InlineKeyboardButton("üêï FLOKI", callback_data='from_FLOKI')],
        [InlineKeyboardButton("üêï BONK", callback_data='from_BONK')],
        [InlineKeyboardButton(get_text(user_id, 'back'), callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        f"{get_text(user_id, 'from_currency')}\n\nüí° {get_text(user_id, 'quick_tip')}",
        reply_markup=reply_markup
    )

async def show_to_currency_menu(query, context):
    """Show target currency selection menu"""
    user_id = query.from_user.id
    from_currency = context.user_data.get('from_currency')
    
    keyboard = [
        [InlineKeyboardButton("üáπüá∑ TRY", callback_data='to_TRY'),
         InlineKeyboardButton("üá¶üáø AZN", callback_data='to_AZN'),
         InlineKeyboardButton("üá∑üá∫ RUB", callback_data='to_RUB')],
        [InlineKeyboardButton("üá∫üá∏ USD", callback_data='to_USD'),
         InlineKeyboardButton("üá™üá∫ EUR", callback_data='to_EUR'),
         InlineKeyboardButton("üá¨üáß GBP", callback_data='to_GBP')],
        [InlineKeyboardButton("‚Çø BTC", callback_data='to_BTC'),
         InlineKeyboardButton("Œû ETH", callback_data='to_ETH'),
         InlineKeyboardButton("üü° BNB", callback_data='to_BNB')],
        [InlineKeyboardButton("üîµ ADA", callback_data='to_ADA'),
         InlineKeyboardButton("üü£ SOL", callback_data='to_SOL'),
         InlineKeyboardButton("üíß XRP", callback_data='to_XRP')],
        [InlineKeyboardButton("üî¥ DOT", callback_data='to_DOT'),
         InlineKeyboardButton("üêï DOGE", callback_data='to_DOGE'),
         InlineKeyboardButton("üü£ MATIC", callback_data='to_MATIC')],
        [InlineKeyboardButton("üî∫ AVAX", callback_data='to_AVAX'),
         InlineKeyboardButton("üîó LINK", callback_data='to_LINK'),
         InlineKeyboardButton("ü¶Ñ UNI", callback_data='to_UNI')],
        [InlineKeyboardButton("‚ö° LTC", callback_data='to_LTC'),
         InlineKeyboardButton("üåå ATOM", callback_data='to_ATOM'),
         InlineKeyboardButton("üëª FTM", callback_data='to_FTM')],
        [InlineKeyboardButton("üîµ ALGO", callback_data='to_ALGO'),
         InlineKeyboardButton("üì∫ VET", callback_data='to_VET'),
         InlineKeyboardButton("üìÅ FIL", callback_data='to_FIL')],
        [InlineKeyboardButton("üåê TRX", callback_data='to_TRX'),
         InlineKeyboardButton("‚≠ê XLM", callback_data='to_XLM'),
         InlineKeyboardButton("üéÆ MANA", callback_data='to_MANA')],
        [InlineKeyboardButton("üèñÔ∏è SAND", callback_data='to_SAND'),
         InlineKeyboardButton("üéØ AXS", callback_data='to_AXS'),
         InlineKeyboardButton("‚öΩ CHZ", callback_data='to_CHZ')],
        [InlineKeyboardButton("üíé ENJ", callback_data='to_ENJ'),
         InlineKeyboardButton("ü¶á BAT", callback_data='to_BAT'),
         InlineKeyboardButton("üîí ZEC", callback_data='to_ZEC')],
        [InlineKeyboardButton("üí® DASH", callback_data='to_DASH'),
         InlineKeyboardButton("üîµ NEO", callback_data='to_NEO'),
         InlineKeyboardButton("üî∑ QTUM", callback_data='to_QTUM')],
        [InlineKeyboardButton("üü† ICX", callback_data='to_ICX'),
         InlineKeyboardButton("üî∑ ONT", callback_data='to_ONT'),
         InlineKeyboardButton("‚ö° ZIL", callback_data='to_ZIL')],
        [InlineKeyboardButton("üåä WAVES", callback_data='to_WAVES'),
         InlineKeyboardButton("üü£ KSM", callback_data='to_KSM'),
         InlineKeyboardButton("üìä GRT", callback_data='to_GRT')],
        [InlineKeyboardButton("üèõÔ∏è COMP", callback_data='to_COMP'),
         InlineKeyboardButton("üí∞ YFI", callback_data='to_YFI'),
         InlineKeyboardButton("üîó SNX", callback_data='to_SNX')],
        [InlineKeyboardButton("üè≠ MKR", callback_data='to_MKR'),
         InlineKeyboardButton("üè¶ AAVE", callback_data='to_AAVE'),
         InlineKeyboardButton("üîÑ CRV", callback_data='to_CRV')],
        [InlineKeyboardButton("1Ô∏è‚É£ 1INCH", callback_data='to_1INCH'),
         InlineKeyboardButton("üç£ SUSHI", callback_data='to_SUSHI'),
         InlineKeyboardButton("ü•û CAKE", callback_data='to_CAKE')],
        [InlineKeyboardButton("üêï SHIB", callback_data='to_SHIb'),
         InlineKeyboardButton("üê∏ PEPE", callback_data='to_PEPE'),
         InlineKeyboardButton("üêï FLOKI", callback_data='to_FLOKI')],
        [InlineKeyboardButton("üêï BONK", callback_data='to_BONK')],
        [InlineKeyboardButton(get_text(user_id, 'back'), callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        f"{get_text(user_id, 'to_currency')}\n\nüí° {get_text(user_id, 'quick_tip')}",
        reply_markup=reply_markup
    )

async def ask_amount(query, context):
    """Ask user for amount to convert"""
    user_id = query.from_user.id
    from_currency = context.user_data.get('from_currency')
    to_currency = context.user_data.get('to_currency')
    
    context.user_data['waiting_for_amount'] = True
    
    keyboard = [[InlineKeyboardButton(get_text(user_id, 'back'), callback_data='back_to_main')]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        f"{get_text(user_id, 'enter_amount')}\n\n{from_currency} ‚Üí {to_currency}",
        reply_markup=reply_markup
    )

def parse_conversion_input(text):
    """Parse text input like '20 USD AZN' or '100 BTC TRY'"""
    import re
    
    # Pattern to match: number currency1 currency2
    pattern = r'(\d+(?:\.\d+)?)\s+([A-Za-z]+)\s+([A-Za-z]+)'
    match = re.match(pattern, text.strip().upper())
    
    if match:
        amount = float(match.group(1))
        from_currency = match.group(2).upper()
        to_currency = match.group(3).upper()
        
        # Validate currencies
        if from_currency in CURRENCY_CODES and to_currency in CURRENCY_CODES:
            return amount, from_currency, to_currency
    
    return None, None, None

async def handle_amount(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle amount input for conversion"""
    user_id = update.effective_user.id
    text = update.message.text.strip()
    
    # Check if it's a direct conversion command like "20 USD AZN"
    amount, from_currency, to_currency = parse_conversion_input(text)
    
    if amount is not None:
        # Direct conversion command
        rates = await get_exchange_rates()
        crypto_rates = await get_crypto_rates()
        
        if not rates and not crypto_rates:
            await update.message.reply_text(get_text(user_id, 'error'))
            return
        
        result = await calculate_conversion(amount, from_currency, to_currency, rates, crypto_rates)
        
        if result is None:
            await update.message.reply_text(get_text(user_id, 'rate_not_found'))
            return
        
        text_result = f"{get_text(user_id, 'result')}\n\n"
        text_result += f"{amount:,.2f} {from_currency} = {result:,.2f} {to_currency}"
        
        keyboard = [[InlineKeyboardButton(get_text(user_id, 'back'), callback_data='back_to_main')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(text_result, reply_markup=reply_markup)
        return
    
    # Original amount input handling
    if not context.user_data.get('waiting_for_amount'):
        return
    
    try:
        amount = float(text)
        from_currency = context.user_data.get('from_currency')
        to_currency = context.user_data.get('to_currency')
        
        # Get exchange rates
        rates = await get_exchange_rates()
        crypto_rates = await get_crypto_rates()
        
        if not rates and not crypto_rates:
            await update.message.reply_text(get_text(user_id, 'error'))
            return
        
        # Calculate conversion
        result = await calculate_conversion(amount, from_currency, to_currency, rates, crypto_rates)
        
        if result is None:
            await update.message.reply_text(get_text(user_id, 'rate_not_found'))
            return
        
        text_result = f"{get_text(user_id, 'result')}\n\n"
        text_result += f"{amount:,.2f} {from_currency} = {result:,.2f} {to_currency}"
        
        keyboard = [[InlineKeyboardButton(get_text(user_id, 'back'), callback_data='back_to_main')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(text_result, reply_markup=reply_markup)
        
        # Clear waiting state
        context.user_data['waiting_for_amount'] = False
        
    except ValueError:
        await update.message.reply_text(get_text(user_id, 'invalid_amount'))

async def calculate_conversion(amount, from_currency, to_currency, rates, crypto_rates):
    """Calculate currency conversion"""
    try:
        # Define all supported cryptocurrencies
        crypto_currencies = [
            'BTC', 'ETH', 'BNB', 'ADA', 'SOL', 'XRP', 'DOT', 'DOGE', 'MATIC', 'AVAX',
            'LINK', 'UNI', 'LTC', 'ATOM', 'FTM', 'ALGO', 'VET', 'FIL', 'TRX', 'XLM',
            'MANA', 'SAND', 'AXS', 'CHZ', 'ENJ', 'BAT', 'ZEC', 'DASH', 'NEO', 'QTUM',
            'ICX', 'ONT', 'ZIL', 'WAVES', 'KSM', 'GRT', 'COMP', 'YFI', 'SNX', 'MKR',
            'AAVE', 'CRV', '1INCH', 'SUSHI', 'CAKE', 'SHIB', 'PEPE', 'FLOKI', 'BONK'
        ]
        
        # Handle crypto to crypto conversions
        if from_currency in crypto_currencies and to_currency in crypto_currencies:
            if crypto_rates and from_currency in crypto_rates and to_currency in crypto_rates:
                # Convert through USD
                from_usd = crypto_rates[from_currency]
                to_usd = crypto_rates[to_currency]
                return amount * from_usd / to_usd
        
        # Handle crypto to fiat conversions
        elif from_currency in crypto_currencies:
            if crypto_rates and from_currency in crypto_rates and rates:
                crypto_usd = crypto_rates[from_currency]
                if to_currency == 'USD':
                    return amount * crypto_usd
                elif to_currency in rates:
                    return amount * crypto_usd * rates[to_currency]
        
        # Handle fiat to crypto conversions
        elif to_currency in crypto_currencies:
            if rates and crypto_rates and to_currency in crypto_rates:
                if from_currency == 'USD':
                    return amount / crypto_rates[to_currency]
                elif from_currency in rates:
                    usd_amount = amount / rates[from_currency]
                    return usd_amount / crypto_rates[to_currency]
        
        # Handle fiat to fiat conversions
        else:
            if rates and from_currency in rates and to_currency in rates:
                if from_currency == 'USD':
                    return amount * rates[to_currency]
                elif to_currency == 'USD':
                    return amount / rates[from_currency]
                else:
                    # Convert through USD
                    usd_amount = amount / rates[from_currency]
                    return usd_amount * rates[to_currency]
        
        return None
    except Exception as e:
        logger.error(f"Error calculating conversion: {e}")
        return None

async def show_language_menu(query, context):
    """Show language selection menu"""
    user_id = query.from_user.id
    
    keyboard = [
        [InlineKeyboardButton("üáπüá∑ T√ºrk√ße", callback_data='lang_tr')],
        [InlineKeyboardButton("üá∫üá∏ English", callback_data='lang_en')],
        [InlineKeyboardButton("üá∑üá∫ –†—É—Å—Å–∫–∏–π", callback_data='lang_ru')],
        [InlineKeyboardButton(get_text(user_id, 'back'), callback_data='back_to_main')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        get_text(user_id, 'language_select'),
        reply_markup=reply_markup
    )

async def show_main_menu(query, context):
    """Show main menu"""
    user_id = query.from_user.id
    
    keyboard = [
        [InlineKeyboardButton(get_text(user_id, 'current_rates'), callback_data='current_rates')],
        [InlineKeyboardButton(get_text(user_id, 'currency_comparison'), callback_data='currency_comparison')],
        [InlineKeyboardButton(get_text(user_id, 'crypto_rates'), callback_data='crypto_rates')],
        [InlineKeyboardButton(get_text(user_id, 'language_select'), callback_data='language_select')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        get_text(user_id, 'main_menu'),
        reply_markup=reply_markup
    )

def main():
    """Main function to run the bot"""
    # Create application
    application = Application.builder().token(BOT_TOKEN).build()
    
    # Add handlers
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CallbackQueryHandler(button_callback))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_amount))
    
    # Start the bot
    print("Bot is starting...")
    application.run_polling()

if __name__ == '__main__':
    main()
